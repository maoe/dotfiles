#!/bin/sh
DOTFILES_DIR=$(ssh $@ 'echo $HOME/dotfiles')
LOCAL_STARSHIP_VERSION=$(starship --version 2>/dev/null | head -1 || echo "")
echo "DOTFILES_DIR=$DOTFILES_DIR"

ssh $@ <<EOF
type git || { echo "You need git to proceed"; exit 1; }
type stow || { echo "You need stow to proceed"; exit 1; }

if [ -d "$DOTFILES_DIR" ]; then
  cd $DOTFILES_DIR
  git pull
  git submodule update --init
else
  git clone --recursive https://github.com/maoe/dotfiles.git $DOTFILES_DIR
fi
cd $DOTFILES_DIR
./install.sh

# Install starship into ~/.local/bin if not already available
if type curl > /dev/null 2>&1; then
  mkdir -p \$HOME/.local/bin
  REMOTE_STARSHIP_VERSION=\$(starship --version 2>/dev/null | head -1 || echo "")
  if [ "$LOCAL_STARSHIP_VERSION" != "\$REMOTE_STARSHIP_VERSION" ]; then
    echo "Installing/updating starship..."
    curl -sS https://starship.rs/install.sh | sh -s -- --bin-dir \$HOME/.local/bin -y
  fi
else
  echo "curl not found; skipping starship installation"
fi
EOF
